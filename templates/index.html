<script>
    // --- Scroll to new section if new_section_id is present in URL ---
    (function () {
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        const newSectionId = getQueryParam('new_section_id');
        if (newSectionId) {
            // Wait for the section to exist, then scroll to it
            function waitForSectionAndScroll(id, maxWait = 2000) {
                const start = Date.now();
                (function check() {
                    const el = document.getElementById('section-' + id);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else if (Date.now() - start < maxWait) {
                        setTimeout(check, 30);
                    }
                })();
            }
            waitForSectionAndScroll(newSectionId);
            // Optionally, clean up the URL
            if (window.history && window.history.replaceState) {
                const url = new URL(window.location.href);
                url.searchParams.delete('new_section_id');
                window.history.replaceState({}, document.title, url.pathname + url.search);
            }
        }
    })();
</script>
<script>
    // Unified reload/scroll restoration utility
    // Unified scroll/selection context utility for sections/notes
    function saveReloadContext(context = {}) {
        // context: { scrollToNewSectionAfter: <sectionId|null> }
        if (context.scrollToNewSectionAfter !== undefined) {
            sessionStorage.setItem('scrollToNewSectionAfter', context.scrollToNewSectionAfter);
        }
    }

    function waitForElement(selector, callback, maxWait = 1000) {
        const start = Date.now();
        (function check() {
            const el = document.querySelector(selector);
            if (el) {
                callback(el);
            } else if (Date.now() - start < maxWait) {
                setTimeout(check, 30);
            }
        })();
    }

    function restoreReloadContext() {
        const afterId = sessionStorage.getItem('scrollToNewSectionAfter');
        if (afterId !== null) {
            // If afterId is '', scroll to the first section (added at top)
            if (afterId === '') {
                waitForElement('.group\\/section', function (el) {
                    el.scrollIntoView({ behavior: 'auto', block: 'center' });
                });
            } else {
                // Find the section that comes after the given id
                const allSections = Array.from(document.querySelectorAll('.group\\/section'));
                let found = false;
                for (let i = 0; i < allSections.length; ++i) {
                    if (allSections[i].id === 'section-' + afterId && allSections[i + 1]) {
                        waitForElement('#' + allSections[i + 1].id, function (el) {
                            el.scrollIntoView({ behavior: 'auto', block: 'center' });
                        });
                        found = true;
                        break;
                    }
                }
                if (!found && allSections.length > 0) {
                    // Fallback: scroll to last section
                    waitForElement('#' + allSections[allSections.length - 1].id, function (el) {
                        el.scrollIntoView({ behavior: 'auto', block: 'center' });
                    });
                }
            }
            sessionStorage.removeItem('scrollToNewSectionAfter');
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        restoreReloadContext();
        // Attach to all Add Section forms
        document.querySelectorAll('form[action$="/add_section"]').forEach(function (form) {
            form.addEventListener('submit', function (e) {
                const afterId = form.querySelector('input[name="after_section_id"]').value;
                saveReloadContext({ scrollToNewSectionAfter: afterId });
            });
        });
    });
</script>
<!-- 
This is a Jinja2 HTML template file.
The {{ template_expressions }} are processed server-side by Flask/Jinja2
before being sent to the browser as valid HTML/JavaScript.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ document.documentTitle }}</title>
    <!-- drag_drop.js will be loaded at the end of body for guaranteed handler availability -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Highlight.js for code block syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- Ensure editors.js is loaded before any code that uses initializeEditors -->
    <script src="{{ url_for('static', filename='js/editors.js') }}"></script>
    <style>
        /* ...existing code... */
        /* Ensure images in note content are always visible and not collapsed */
        .note-content img {
            min-width: 80px !important;
            min-height: 60px !important;
            display: inline-block !important;
            object-fit: contain;
            background: #f8fafc;
            border-radius: 6px;
        }

        /* Optionally, add a subtle border for tiny images */
        .note-content img[width],
        .note-content img[height] {
            border: 1px solid #e5e7eb;
        }
    </style>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Custom image resize implementation
        function makeImageResizable(quillInstance) {
            const quill = quillInstance;
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: absolute;
                display: none;
                z-index: 1000;
                box-sizing: border-box;
                pointer-events: none;
                border: 2px dashed #444;
            `;

            const handles = [];
            for (let i = 0; i < 4; i++) {
                const handle = document.createElement('div');
                handle.style.cssText = `
                    position: absolute;
                    width: 8px;
                    height: 8px;
                    background: white;
                    border: 1px solid #333;
                    cursor: ${i % 2 === 0 ? 'nw-resize' : 'ne-resize'};
                    pointer-events: auto;
                `;
                overlay.appendChild(handle);
                handles.push(handle);
            }

            // Append overlay to the quill editor container instead of body
            quill.root.parentNode.appendChild(overlay);

            let selectedImg = null;
            let isResizing = false;
            let startX, startY, startWidth, startHeight;

            function positionOverlay(img) {
                const imgRect = img.getBoundingClientRect();
                const editorRect = quill.root.getBoundingClientRect();
                const containerRect = quill.root.parentNode.getBoundingClientRect();

                // Calculate position relative to the editor container
                const relativeLeft = imgRect.left - containerRect.left + quill.root.parentNode.scrollLeft;
                const relativeTop = imgRect.top - containerRect.top + quill.root.parentNode.scrollTop;

                // Calculate visible boundaries
                const editorLeft = editorRect.left - containerRect.left;
                const editorTop = editorRect.top - containerRect.top;
                const editorRight = editorLeft + editorRect.width;
                const editorBottom = editorTop + editorRect.height;

                // Overlay boundaries
                const overlayLeft = relativeLeft - 2;
                const overlayTop = relativeTop - 2;
                const overlayRight = overlayLeft + imgRect.width + 4;
                const overlayBottom = overlayTop + imgRect.height + 4;

                // Clip overlay to editor viewport
                const clippedLeft = Math.max(overlayLeft, editorLeft);
                const clippedTop = Math.max(overlayTop, editorTop);
                const clippedRight = Math.min(overlayRight, editorRight);
                const clippedBottom = Math.min(overlayBottom, editorBottom);

                // Only show overlay if there's a visible area
                if (clippedLeft < clippedRight && clippedTop < clippedBottom) {
                    overlay.style.display = 'block';
                    overlay.style.left = clippedLeft + 'px';
                    overlay.style.top = clippedTop + 'px';
                    overlay.style.width = (clippedRight - clippedLeft) + 'px';
                    overlay.style.height = (clippedBottom - clippedTop) + 'px';

                    // Dynamically set border visibility based on clipping
                    overlay.style.borderTopStyle = (overlayTop >= editorTop) ? 'dashed' : 'none';
                    overlay.style.borderBottomStyle = (overlayBottom <= editorBottom) ? 'dashed' : 'none';
                    overlay.style.borderLeftStyle = (overlayLeft >= editorLeft) ? 'dashed' : 'none';
                    overlay.style.borderRightStyle = (overlayRight <= editorRight) ? 'dashed' : 'none';

                    // Position handles only if they're within the visible area
                    const handlePositions = [
                        { left: overlayLeft - clippedLeft - 4, top: overlayTop - clippedTop - 4 }, // top-left
                        { right: clippedRight - overlayRight - 4, top: overlayTop - clippedTop - 4 }, // top-right
                        { right: clippedRight - overlayRight - 4, bottom: clippedBottom - overlayBottom - 4 }, // bottom-right
                        { left: overlayLeft - clippedLeft - 4, bottom: clippedBottom - overlayBottom - 4 } // bottom-left
                    ];

                    handles.forEach((handle, index) => {
                        const pos = handlePositions[index];

                        // Check if handle would be visible
                        const handleVisible =
                            (pos.left !== undefined ? pos.left >= -4 && pos.left <= (clippedRight - clippedLeft) : true) &&
                            (pos.right !== undefined ? pos.right >= -4 && pos.right <= (clippedRight - clippedLeft) : true) &&
                            (pos.top !== undefined ? pos.top >= -4 && pos.top <= (clippedBottom - clippedTop) : true) &&
                            (pos.bottom !== undefined ? pos.bottom >= -4 && pos.bottom <= (clippedBottom - clippedTop) : true);

                        if (handleVisible) {
                            handle.style.display = 'block';
                            handle.style.left = pos.left !== undefined ? pos.left + 'px' : 'auto';
                            handle.style.right = pos.right !== undefined ? pos.right + 'px' : 'auto';
                            handle.style.top = pos.top !== undefined ? pos.top + 'px' : 'auto';
                            handle.style.bottom = pos.bottom !== undefined ? pos.bottom + 'px' : 'auto';
                        } else {
                            handle.style.display = 'none';
                        }
                    });
                } else {
                    overlay.style.display = 'none';
                }
            }

            function hideOverlay() {
                overlay.style.display = 'none';
                selectedImg = null;
            }

            // Update overlay position on scroll
            function updateOverlayPosition() {
                if (selectedImg && overlay.style.display === 'block') {
                    positionOverlay(selectedImg);
                }
            }

            // Listen for scroll events on the editor container and window
            quill.root.addEventListener('scroll', updateOverlayPosition);
            window.addEventListener('scroll', updateOverlayPosition);

            // Click handler for images
            quill.root.addEventListener('click', function (e) {
                if (e.target.tagName === 'IMG') {
                    selectedImg = e.target;
                    positionOverlay(selectedImg);
                } else {
                    hideOverlay();
                }
            });

            // Handle resize
            handles.forEach((handle, index) => {
                handle.addEventListener('mousedown', function (e) {
                    if (!selectedImg) return;

                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = selectedImg.width || selectedImg.offsetWidth;
                    startHeight = selectedImg.height || selectedImg.offsetHeight;

                    e.preventDefault();
                });
            });

            document.addEventListener('mousemove', function (e) {
                if (!isResizing || !selectedImg) return;

                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;

                // Calculate new dimensions (maintain aspect ratio)
                const ratio = startHeight / startWidth;
                let newWidth = startWidth + deltaX;
                let newHeight = newWidth * ratio;

                if (newWidth > 50) { // Minimum width
                    selectedImg.style.width = newWidth + 'px';
                    selectedImg.style.height = newHeight + 'px';

                    // Set actual width and height attributes for proper saving
                    selectedImg.setAttribute('width', Math.round(newWidth));
                    selectedImg.setAttribute('height', Math.round(newHeight));

                    positionOverlay(selectedImg);

                    // Trigger Quill content update to ensure changes are saved
                    if (quill) {
                        quill.root.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            });

            document.addEventListener('mouseup', function () {
                if (isResizing && selectedImg && quill) {
                    // Force Quill to update its content
                    const content = quill.root.innerHTML;
                    quill.root.innerHTML = content;

                    // Trigger text-change event to update hidden fields
                    quill.emitter.emit('text-change');
                }
                isResizing = false;
            });

            // Hide overlay when clicking outside
            document.addEventListener('click', function (e) {
                if (!quill.root.contains(e.target) && !overlay.contains(e.target)) {
                    hideOverlay();
                }
            });
        }

        // Make it available globally
        window.makeImageResizable = makeImageResizable;
    </script>
    <script>
        // Debug script to check if modules are loading
        console.log('Quill loaded:', typeof Quill);
        console.log('Custom resize function:', typeof window.makeImageResizable);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="{{ url_for('static', filename='js/content-menu.js') }}"></script>
    <!-- drag_drop.js will be loaded at the end of body for guaranteed handler availability -->
</head>

<body class="bg-gray-50">
    <!-- Floating Search and Content Menu Buttons/Widgets -->
    <div class="fixed top-6 left-6 z-50 flex flex-col items-start">
        <div class="flex flex-row items-center gap-2">
            <button id="find-in-text-toggle" type="button"
                class="rounded-full bg-white shadow-lg border border-gray-300 px-4 py-2 text-gray-700 font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                title="Find in text">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2" class="inline-block mr-2 align-middle">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
                <span class="align-middle">Search</span>
            </button>
            <button id="content-menu-toggle" type="button"
                class="rounded-full bg-white shadow-lg border border-gray-300 px-4 py-2 text-gray-700 font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                title="Show content menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2" class="inline-block mr-2 align-middle">
                    <rect x="4" y="4" width="16" height="16" rx="3" />
                    <line x1="8" y1="8" x2="16" y2="8" />
                    <line x1="8" y1="12" x2="16" y2="12" />
                    <line x1="8" y1="16" x2="12" y2="16" />
                </svg>
                <span class="align-middle">Contents</span>
            </button>
        </div>
        <div id="find-in-text-widget" class="flex flex-col items-start">
            <div id="find-in-text-panel" style="display:none;"
                class="mt-2 bg-white rounded-xl shadow-xl border border-gray-200 p-3 flex flex-col gap-2 w-80">
                <div class="flex items-center gap-2">
                    <input id="find-in-text-input" type="text" placeholder="Find in text..."
                        class="flex-grow border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    <button id="find-in-text-close"
                        class="ml-1 text-gray-400 hover:text-gray-600 p-1 rounded-full focus:outline-none"
                        title="Close">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <input id="find-in-text-replace" type="text" placeholder="Replace with..."
                        class="flex-grow border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-green-400" />
                    <button id="find-in-text-replace-all"
                        class="p-2 text-green-600 hover:text-green-700 hover:bg-green-50 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 transition-colors"
                        title="Replace all occurrences">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2H5a2 2 0 0 0-2-2z"/>
                            <polyline points="3,7 8,12 3,17"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-center gap-2 justify-between">
                    <div class="flex items-center gap-1">
                        <button id="find-in-text-prev"
                            class="text-gray-600 hover:text-blue-600 p-1 rounded-full focus:outline-none"
                            title="Previous">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6" />
                            </svg>
                        </button>
                        <button id="find-in-text-next"
                            class="text-gray-600 hover:text-blue-600 p-1 rounded-full focus:outline-none" title="Next">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <polyline points="9 6 15 12 9 18" />
                            </svg>
                        </button>
                    </div>
                    <span id="find-in-text-count" class="text-xs text-gray-500">0 / 0</span>
                </div>
            </div>
        </div>
        <div id="content-menu-widget" class="flex flex-col items-start">
            <div id="content-menu-panel" style="display:none; max-height:70vh; min-width:16rem;"
                class="mt-2 bg-white rounded-xl shadow-xl border border-gray-200 p-3 flex flex-col gap-2 overflow-y-auto">
                <!-- Content menu will be dynamically generated here -->
            </div>
        </div>
    </div>
    <style>
        /* Highlight for found text */
        .find-in-text-highlight {
            background: #ffe066;
            color: #222;
            border-radius: 3px;
            padding: 0 2px;
            box-decoration-break: clone;
        }

        .find-in-text-current {
            background: #ffd166;
            color: #111;
            border-radius: 3px;
            padding: 0 2px;
            box-shadow: 0 0 0 2px #f59e42;
        }

        /* Dropzone highlight for drag-and-drop */
        .dropzone.drag-over {
            background: #e0e7ff !important;
            box-shadow: 0 0 0 2px #6366f1;
            transition: background 0.2s, box-shadow 0.2s;
        }

        /* Replace functionality styling */
        #find-in-text-replace:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        #find-in-text-replace-all:active {
            transform: translateY(1px);
        }

        #find-in-text-replace-all:disabled {
            color: #9ca3af !important;
            cursor: not-allowed;
            transform: none;
            background-color: transparent !important;
        }

        #find-in-text-replace-all:disabled:hover {
            color: #9ca3af !important;
            background-color: transparent !important;
        }

        /* Loading spinner animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Modal responsive improvements */
        .modal-body {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Ensure consistent modal heights */
        .modal-container {
            max-height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
        }

        .modal-container form {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .modal-container .modal-body {
            flex: 1;
            overflow-y: auto;
        }

        @media (max-height: 600px) {
            .modal-body {
                max-height: calc(100vh - 150px);
            }
        }

        @media (max-height: 500px) {
            .modal-body {
                max-height: calc(100vh - 120px);
            }
        }
    </style>

    </script>
    <script>
        // Make current state available to JavaScript
        window.currentState = {{ current_state | tojson }};
    </script>

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8 my-8">
        <div id="main-content">

            <div class="flex items-center group mb-6 pb-4 border-b">
                <h1 class="text-3xl font-bold text-gray-800">{{ document.documentTitle }}</h1>
                <button onclick="showModal('editTitleModal')"
                    class="ml-3 opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-gray-500 hover:text-blue-600">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
            </div>

            <div class="bg-gray-100 p-4 rounded-lg mb-6">
                <div class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b">
                    <h3 class="text-sm font-semibold text-gray-600">CURRENT STATE:</h3>
                    <select onchange="window.location.href = this.value"
                        class="current-state-dropdown p-2 border border-gray-300 rounded-md text-sm font-medium">
                        {% for state_name in available_states %}
                        <option value="{{ url_for('index', state=state_name) }}" {% if state_name==current_state
                            %}selected{% endif %}>
                            {{ state_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button onclick="showCreateStateModal()"
                        class="text-sm font-medium text-green-600 bg-green-100 hover:bg-green-200 px-3 py-1.5 rounded-full transition-colors new-state-btn px-3 py-1.5">
                        + New State
                    </button>
                    <button onclick="showRenameStateModal('{{ current_state }}')"
                        class="text-sm font-medium text-blue-600 bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded-full transition-colors">
                        Rename Current State
                    </button>
                    <form action="{{ url_for('delete_state') }}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete the state \'{{ current_state }}\'? This action cannot be undone.');"
                        class="inline">
                        <input type="hidden" name="state_to_delete" value="{{ current_state }}">
                        <button type="submit"
                            class="text-sm font-medium text-red-600 bg-red-100 hover:bg-red-200 px-3 py-1.5 rounded-full transition-colors">
                            Delete Current State
                        </button>
                    </form>
                </div>

                <div class="pt-4">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">TAG CATEGORIES</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <button onclick="showAddCategoryModal()"
                            class="text-sm font-medium text-purple-600 bg-purple-100 hover:bg-purple-200 px-3 py-1.5 rounded-full transition-colors">
                            + New Category
                        </button>
                        <button onclick="showAddAndTagModal()"
                            class="text-sm font-medium text-orange-600 bg-orange-100 hover:bg-orange-200 px-3 py-1.5 rounded-full transition-colors">
                            + New AND Tag
                        </button>
                    </div>

                    {% if and_tags %}
                    <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                        <div class="flex justify-between items-center tag-category-header">
                            <h4 class="font-semibold text-gray-700 flex items-center">
                                AND Tags
                            </h4>
                            <span class="text-xs text-gray-500">{{ and_tags|length }} tags</span>
                        </div>
                        <div id="and-tags-content" class="tag-category-content dropzone flex flex-wrap gap-2 p-2 mt-2"
                            data-category-id="and_tags">
                            {% for tag in and_tags %}
                            <span
                                class="tag-bubble and-tag {% if tag.lower() in active_filters_lower %}active-filter{% else %}inactive-filter{% endif %} relative group/tag"
                                draggable="true" data-tag-name="{{ tag }}" data-source-category-id="and_tags">
                                <div class="flex flex-wrap items-center gap-1"
                                    onclick='handleTagClick(event, {{ tag|tojson|safe }})'
                                    oncontextmenu='showTagContextMenu(event, {{ tag|tojson|safe }}); return false;'>
                                    {% for component in tag.split('&') %}
                                    <span
                                        class="and-tag-component bg-white bg-opacity-80 px-2 py-1 rounded text-xs border"
                                        oncontextmenu='showTagContextMenu(event, {{ tag|tojson|safe }}); return false;'>
                                        {{ component }}
                                    </span>
                                    {% endfor %}
                                </div>
                                <div
                                    class="absolute -top-8 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-md p-1 flex items-center z-20 opacity-0 group-hover/tag:opacity-100 transition-opacity pointer-events-none group-hover/tag:pointer-events-auto">
                                    <button
                                        onclick="event.preventDefault(); event.stopPropagation(); showEditAndTagModal('{{ tag }}')"
                                        class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button
                                        onclick="event.preventDefault(); event.stopPropagation(); deleteAndTag('{{ tag }}', '{{ url_for('delete_and_tag', state=current_state) }}')"
                                        class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2v2">
                                            </path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </div>
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                        {# Show all tags as a flat list #}
                        <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                            <div class="flex justify-between items-center tag-category-header">
                                <h4 class="font-semibold text-gray-700 flex items-center">
                                    All Tags
                                </h4>
                                <span class="text-xs text-gray-500">{{ all_tags|length }} tags</span>
                            </div>
                            <div id="all-tags-content"
                                class="tag-category-content dropzone flex flex-wrap gap-2 p-2 mt-2">
                                {# Combine all_tags and all category tags, avoiding duplicates #}
                                {% set combined_tags = all_tags[:] %}
                                {% for category in tag_categories %}
                                {% for tag in category.tags %}
                                {% if tag not in combined_tags and not tag.startswith('CATEGORY:') %}
                                {% set _ = combined_tags.append(tag) %}
                                {% endif %}
                                {% endfor %}
                                {% endfor %}
                                {% for tag in combined_tags %}
                                <span
                                    class="tag-bubble {% if tag in and_tags %}and-tag{% elif tag.lower() in active_filters_lower %}active-filter{% else %}inactive-filter{% endif %} relative group/tag"
                                    draggable="{{ 'false' if tag.lower() == 'all' else 'true' }}"
                                    data-tag-name="{{ tag }}" data-source-category-id="all_tags">
                                    <span onclick='handleTagClick(event, {{ tag|tojson|safe }})'
                                        oncontextmenu='showTagContextMenu(event, {{ tag|tojson|safe }}); return false;'>{{ tag }}</span>
                                    <div
                                        class="absolute -top-8 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-md p-1 flex items-center z-20 opacity-0 group-hover/tag:opacity-100 transition-opacity pointer-events-none group-hover/tag:pointer-events-auto">
                                        <button
                                            onclick='event.stopPropagation(); showRenameModal({{ tag|tojson|safe }})'
                                            class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-md"
                                            title="Rename tag">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                                </path>
                                            </svg>
                                        </button>
                                        <form
                                            action="{{ url_for('delete_global_tag', filter=request.args.getlist('filter'), state=current_state) }}"
                                            method="post"
                                            onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete the tag ' + {{ tag|tojson }} + ' everywhere?');"
                                            class="inline">
                                            <input type="hidden" name="tag_to_delete" value="{{ tag }}">
                                            <button type="submit" onclick="event.stopPropagation();"
                                                class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded-md">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="3 6 5 6 21 6"></polyline>
                                                    <path
                                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2v2">
                                                    </path>
                                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                </span>
                                {% endfor %}
                                {% if not combined_tags %}
                                <span class="text-sm text-gray-500 italic">No tags available.</span>
                                {% endif %}
                            </div>
                        </div>

                        {% for category in tag_categories %}
                        {% if category.name.lower() != 'uncategorized' %}
                        <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                            <div class="flex flex-row items-center tag-category-header gap-1" style="min-height:40px;">
                                <h4 class="text-lg font-semibold text-gray-700 flex-1">{{ category.name }}</h4>
                                <span class="text-xs text-gray-500">{{ category.tags|length }} tags</span>
                                <div class="flex flex-row items-center gap-0">
                                    <button type="button"
                                        onclick="event.stopPropagation(); showRenameCategoryModal('{{ category.id }}', '{{ category.name }}')"
                                        class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200 rounded-full flex items-center justify-center align-middle"
                                        style="height:32px;width:32px;" title="Rename Category">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        <script>document.currentScript.parentElement && document.currentScript.parentElement.addEventListener('click', function (e) { window.appLogger?.buttonClick('RENAME_CATEGORY_BUTTON', { id: '{{ category.id }}', name: '{{ category.name }}' }); });</script>
                                    </button>
                                    <form action="{{ url_for('delete_category', state=current_state) }}" method="post"
                                        onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete the category \'{{ category.name }}\'? Its tags will be moved to Uncategorized.');"
                                        class="inline m-0 p-0" style="display:inline;">
                                        <input type="hidden" name="category_id_to_delete" value="{{ category.id }}">
                                        <button type="submit"
                                            class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-gray-200 rounded-full flex items-center justify-center align-middle ml-0"
                                            style="height:32px;width:32px;" title="Delete Category">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2v2">
                                                </path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                            </svg>
                                            <script>document.currentScript.parentElement && document.currentScript.parentElement.addEventListener('click', function (e) { window.appLogger?.buttonClick('DELETE_CATEGORY_BUTTON', { id: '{{ category.id }}', name: '{{ category.name }}' }); });</script>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div id="category-{{ category.id }}-content"
                                class="tag-category-content dropzone flex flex-wrap gap-2 p-2 mt-2"
                                data-category-id="{{ category.id }}">
                                {% for tag in category.tags %}
                                {% if not tag.startswith('CATEGORY:') %}
                                <span
                                    class="tag-bubble {% if tag in and_tags %}and-tag{% elif tag.lower() in active_filters_lower %}active-filter{% else %}inactive-filter{% endif %} relative group/tag"
                                    draggable="{{ 'false' if tag.lower() == 'all' else 'true' }}"
                                    data-tag-name="{{ tag }}" data-source-category-id="{{ category.id }}" data-category-id="{{ category.id }}">
                                    <span onclick='handleTagClick(event, {{ tag|tojson|safe }})'
                                        oncontextmenu='showTagContextMenu(event, {{ tag|tojson|safe }}, {{ category.id|tojson|safe }}); return false;'>{{ tag }}</span>
                                    <div
                                        class="absolute -top-8 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-md p-1 flex items-center z-20 opacity-0 group-hover/tag:opacity-100 transition-opacity pointer-events-none group-hover/tag:pointer-events-auto">
                                        <button
                                            onclick='window.appLogger?.buttonClick("RENAME_TAG_BUTTON", { tag: {{ tag|tojson|safe }} }); event.preventDefault(); event.stopPropagation(); showRenameModal({{ tag|tojson|safe }})'
                                            class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-md">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                                </path>
                                            </svg>
                                        </button>
                                        <form
                                            action="{{ url_for('delete_global_tag', filter=request.args.getlist('filter'), state=current_state) }}"
                                            method="post"
                                            onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete the tag ' + {{ tag|tojson }} + ' everywhere?');"
                                            class="inline">
                                            <input type="hidden" name="tag_to_delete" value="{{ tag }}">
                                            <button type="submit" onclick="event.stopPropagation();"
                                                class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded-md">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="3 6 5 6 21 6"></polyline>
                                                    <path
                                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2v2">
                                                    </path>
                                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                                </svg>
                                                <script>document.currentScript.previousElementSibling && document.currentScript.previousElementSibling.addEventListener('click', function (e) { window.appLogger?.buttonClick('DELETE_TAG_BUTTON', { tag: {{ tag| tojson | safe }} }); });</script>
                                            </button>
                                        </form>
                                    </div>
                                </span>
                                {% endif %}
                                {% endfor %}
                                {% if not category.tags %}
                                <span class="text-sm text-gray-500 italic">Drag tags here.</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                        <div class="mt-4 flex justify-start">
                            {% if active_filters %}
                            <a href="{{ url_for('index', state=current_state) }}"
                                class="text-sm font-medium text-white bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-full transition-colors">
                                Clear Filters
                            </a>
                            {% endif %}
                        </div>
                        <!-- Save as PDF and Manual Import Content buttons below all categories and above main content -->
                        <div class="mt-8 pt-6 border-t flex flex-row items-center justify-end gap-3">
                            <button type="button" onclick="showImportModal()"
                                class="flex items-center justify-center px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-all">
                                Manual Import Content
                            </button>
                            <button onclick="exportPdf()"
                                class="flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-all">
                                Save as PDF
                            </button>
                            <button onclick="resetCompletionStatus()"
                                class="flex items-center justify-center px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition-all">
                                Reset Completion Status
                            </button>
                            <button onclick="expandAll()"
                                class="flex items-center justify-center px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all">
                                Expand All
                            </button>
                        </div>
                    </div>
                </div>

                <div id="content-to-export" class="space-y-6">
                    <div id="content-to-export" class="space-y-6">
                        {% if sections|length > 0 %}
                        {# Add Section button at top #}
                        <div class="group relative flex justify-center mb-2">
                            <form
                                action="{{ url_for('add_section', filter=request.args.getlist('filter'), state=current_state) }}"
                                method="post" class="transition-opacity opacity-0 group-hover:opacity-100">
                                <input type="hidden" name="after_section_id" value="">
                                <button type="submit"
                                    class="flex items-center justify-center px-2 py-1 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="mr-1">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Section
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        {% for section in sections %}
                        <div id="section-{{ section.id }}"
                            class="bg-gray-50/70 border border-gray-200/80 p-5 rounded-lg group/section{% if section.collapsed %} collapsed{% endif %}">
                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    // Restore scroll position or scroll to new section if marker exists
                                    if (window.localStorage) {
                                        const scrollTarget = localStorage.getItem('scrollTargetSectionId');
                                        if (scrollTarget) {
                                            const el = document.getElementById('section-' + scrollTarget);
                                            if (el) {
                                                el.scrollIntoView({ behavior: 'auto', block: 'center' });
                                            }
                                            localStorage.removeItem('scrollTargetSectionId');
                                        } else if (localStorage.getItem('scrollY')) {
                                            window.scrollTo(0, parseInt(localStorage.getItem('scrollY'), 10));
                                            localStorage.removeItem('scrollY');
                                        }
                                    }
                                    // Attach to all Add Section forms
                                    document.querySelectorAll('form[action$="/section/add"]').forEach(function (form) {
                                        form.addEventListener('submit', function (e) {
                                            if (window.localStorage) {
                                                // Try to find the section after which we're adding
                                                var afterId = form.querySelector('input[name="after_section_id"]').value;
                                                if (afterId) {
                                                    localStorage.setItem('scrollTargetSectionId', afterId);
                                                } else {
                                                    // If adding at the top, scroll to the first section if it exists
                                                    var firstSection = document.querySelector('.group\\/section');
                                                    if (firstSection && firstSection.id) {
                                                        localStorage.setItem('scrollTargetSectionId', firstSection.id.replace('section-', ''));
                                                    } else {
                                                        localStorage.setItem('scrollY', window.scrollY);
                                                    }
                                                }
                                            }
                                        });
                                    });
                                });
                            </script>
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <button type="button" class="collapse-btn mr-2 text-gray-400 hover:text-gray-700"
                                        onclick="toggleSectionCollapse('{{ section.id }}')"
                                        title="Collapse/Expand Section">
                                        <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" width="18"
                                            height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                            stroke-width="2">
                                            {% if section.collapsed %}
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 6l6 6-6 6" />
                                            {% else %}
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
                                            {% endif %}
                                        </svg>
                                    </button>
                                    <h2 class="text-xl font-semibold text-gray-800">{{ section.sectionTitle }}</h2>
                                </div>
                                <div
                                    class="section-action-buttons opacity-0 group-hover/section:opacity-100 transition-opacity">
                                    <button type="button" class="text-gray-500 hover:text-green-600 hover:bg-green-100"
                                        onclick="toggleNoteReorderMode('{{ section.id }}')" title="Reorder Notes">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M8 9h8M8 15h8M10 5h4M10 19h4" />
                                        </svg>
                                    </button>
                                    <button data-section-id="{{ section.id }}"
                                        data-section-title="{{ section.sectionTitle }}"
                                        data-section-tags="{% for tag in section.tags %}{{ tag }}{% if not loop.last %}, {% endif %}{% endfor %}"
                                        data-section-categories='{{ (section.categories or []) | tojson | safe }}'
                                        onclick="showEditSectionModalFromData(this)"
                                        class="text-gray-500 hover:text-blue-600 hover:bg-gray-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <form
                                        action="{{ url_for('delete_section', section_id=section.id, filter=request.args.getlist('filter'), state=current_state) }}"
                                        method="post"
                                        onsubmit="return confirm('Are you sure you want to delete this section and all its notes?');"
                                        class="inline">
                                        <button type="submit"
                                            class="text-gray-500 hover:text-red-600 hover:bg-gray-200">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2v2">
                                                </path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </div>

<div class="flex flex-wrap mb-4">
    {% if section.tags %}
        {% for tag in section.tags %}
            <span class="text-xs font-semibold mr-2 mb-1 px-2.5 py-1 rounded-full 
                {% if tag.startswith('CATEGORY:') %}
                    bg-green-100 text-green-800
                {% elif tag.lower() == 'all' %}
                    bg-purple-200 text-purple-800
                {% else %}
                    bg-blue-100 text-blue-800
                {% endif %}">
                {% if tag.startswith('CATEGORY:') %}
                    📁 {{ tag[9:] }}
                {% else %}
                    {{ tag }}
                {% endif %}
            </span>
        {% endfor %}
    {% endif %}
    {% if section.categories %}
        {% for cat_id in section.categories %}
            {% set cat_obj = (tag_categories | selectattr('id', 'equalto', cat_id) | list | first) %}
            {% if cat_obj %}
                <span class="text-xs font-semibold mr-2 mb-1 px-2.5 py-1 rounded-full bg-green-100 text-green-800 flex items-center">
                    <span class="mr-1">📁</span>{{ cat_obj.name }}
                </span>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

                            <div class="space-y-4 pl-4 border-l-2 border-gray-200 note-list{% if section.collapsed %} collapsed-content{% endif %}"
                                id="note-list-{{ section.id }}"
                                ondragover="onNoteListDragOver(event, '{{ section.id }}')"
                                ondrop="onNoteListDrop(event, '{{ section.id }}')">
                                {% for note in section.notes %}
                                <div id="note-{{ note.id }}" data-note-id="{{ note.id }}"
                                    class="p-4 rounded-md shadow-sm group/note note-draggable{% if note.completed %} note-completed{% else %} bg-white{% endif %}{% if note.collapsed %} collapsed{% endif %}"
                                    {% if note.completed %}data-completed="true" {% endif %} draggable="false"
                                    ondragstart="onNoteDragStart(event, '{{ section.id }}')"
                                    ondragover="onNoteDragOver(event, '{{ section.id }}')"
                                    ondrop="onNoteDrop(event, '{{ section.id }}')" ondragend="onNoteDragEnd(event)">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <button type="button"
                                                class="collapse-btn mr-2 text-gray-400 hover:text-gray-700"
                                                onclick="toggleNoteCollapse('{{ note.id }}')"
                                                title="Collapse/Expand Note">
                                                <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" width="16"
                                                    height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                                    stroke-width="2">
                                                    {% if note.collapsed %}
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M9 6l6 6-6 6" />
                                                    {% else %}
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M6 9l6 6 6-6" />
                                                    {% endif %}
                                                </svg>
                                            </button>
                                            <span
                                                class="note-drag-handle hidden mr-2 cursor-move select-none text-gray-400"
                                                title="Drag to reorder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                                    stroke-width="2">
                                                    <circle cx="6" cy="7" r="1.5" />
                                                    <circle cx="6" cy="12" r="1.5" />
                                                    <circle cx="6" cy="17" r="1.5" />
                                                    <circle cx="12" cy="7" r="1.5" />
                                                    <circle cx="12" cy="12" r="1.5" />
                                                    <circle cx="12" cy="17" r="1.5" />
                                                    <circle cx="18" cy="7" r="1.5" />
                                                    <circle cx="18" cy="12" r="1.5" />
                                                    <circle cx="18" cy="17" r="1.5" />
                                                </svg>
                                            </span>
                                            <button onclick="toggleNoteCompleted('{{ section.id }}', '{{ note.id }}')"
                                                class="mr-2 p-1.5 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-400 transition"
                                                title="Mark as complete/incomplete">
                                                {% if note.completed %}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                                    stroke-width="2" class="text-green-600">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M5 13l4 4L19 7" />
                                                </svg>
                                                {% else %}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                                    stroke-width="2" class="text-gray-400">
                                                    <rect x="4" y="4" width="16" height="16" rx="4" fill="none"
                                                        stroke="currentColor" stroke-width="2" />
                                                </svg>
                                                {% endif %}
                                            </button>
                                            <h3 class="text-lg font-semibold text-gray-700">{{ note.noteTitle }}</h3>
                                        </div>
                                        <div
                                            class="note-action-buttons opacity-0 group-hover/note:opacity-100 transition-opacity">
                                            <button onclick="showEditNoteModal(this)"
                                                data-section-id='{{ section.id | tojson | safe }}'
                                                data-note-id='{{ note.id | tojson | safe }}'
                                                data-title='{{ note.noteTitle | tojson | safe }}'
                                                data-content='{{ note.content | tojson | safe }}'
                                                data-tags='{{ note.tags | tojson | safe }}'
                                                data-categories='{{ (note.categories or []) | tojson | safe }}'
                                                class="text-gray-500 hover:text-blue-600 hover:bg-gray-200">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path
                                                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7">
                                                    </path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                                    </path>
                                                </svg>
                                            </button>
                                            <form
                                                action="{{ url_for('delete_note', section_id=section.id, note_id=note.id, filter=request.args.getlist('filter'), state=current_state) }}"
                                                method="post" onsubmit="return confirm('Are you sure?');"
                                                class="inline">
                                                <button type="submit"
                                                    class="text-gray-500 hover:text-red-600 hover:bg-gray-200">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path
                                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2v2">
                                                        </path>
                                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap my-2">
                                        {% if note.tags %}
                                        {% for tag in note.tags %}
                                        <span class="text-xs font-semibold mr-2 mb-1 px-2.5 py-1 rounded-full 
                {% if tag.startswith('CATEGORY:') %}
                    bg-green-100 text-green-800
                {% elif tag.lower() == 'all' %}
                    bg-purple-200 text-purple-800
                {% else %}
                    bg-blue-100 text-blue-800
                {% endif %}
            ">
                                            {% if tag.startswith('CATEGORY:') %}
                                            📁 {{ tag[9:] }}
                                            {% else %}
                                            {{ tag }}
                                            {% endif %}
                                        </span>
                                        {% endfor %}
                                        {% endif %}
                                        {% if note.categories %}
                                        {% for cat_id in note.categories %}
                                        {% set cat_obj = (tag_categories | selectattr('id', 'equalto', cat_id) | list |
                                        first) %}
                                        {% if cat_obj %}
                                        <span
                                            class="text-xs font-semibold mr-2 mb-1 px-2.5 py-1 rounded-full bg-green-100 text-green-800 flex items-center">
                                            <span class="mr-1">📁</span>{{ cat_obj.name }}
                                        </span>
                                        {% endif %}
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="note-content{% if note.collapsed %} collapsed-content{% endif %}">
                                        <div class="prose prose-sm max-w-none mt-2 text-gray-600">
                                            {{ note.content | safe }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                <form
                                    action="{{ url_for('add_note', section_id=section.id, filter=request.args.getlist('filter'), state=current_state) }}"
                                    method="post">
                                    <button type="submit"
                                        class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Add Note
                                    </button>
                                </form>
                            </div>
                        </div>
                        {# Add Section button between sections, but not after the last section #}
                        {% if not loop.last %}
                        <div class="group relative flex justify-center my-2">
                            <form
                                action="{{ url_for('add_section', filter=request.args.getlist('filter'), state=current_state) }}"
                                method="post" class="transition-opacity opacity-0 group-hover:opacity-100">
                                <input type="hidden" name="after_section_id" value="{{ section.id }}">
                                <button type="submit"
                                    class="flex items-center justify-center px-2 py-1 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="mr-1">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Section
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        {% endfor %}
                        {# Add Section button below the last section, or as the only button if no sections exist #}
                        <div class="group relative flex justify-center mt-2">
                            <form
                                action="{{ url_for('add_section', filter=request.args.getlist('filter'), state=current_state) }}"
                                method="post" class="transition-opacity opacity-0 group-hover:opacity-100">
                                <input type="hidden" name="after_section_id"
                                    value="{{ sections|length > 0 and sections[-1].id or '' }}">
                                <button type="submit"
                                    class="flex items-center justify-center px-2 py-1 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="mr-1">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Section
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Removed duplicate Manual Import Content and Save as PDF buttons as requested -->
            </div>

            <!-- End main content container -->
        </div>

        <!-- Move all modal containers to the end of the HTML file, outside main-content container -->
        <div id="addTagModal"
            class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                <form
                    action="{{ url_for('add_global_tag', filter=request.args.getlist('filter'), state=current_state) }}"
                    method="post" class="w-full">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-xl font-semibold">Create New Tag</h3>
                        <button type="button" onclick="hideModal('addTagModal')"
                            class="hover:bg-gray-200">&times;</button>
                    </div>
                    <div class="p-6">
                        <label for="new_tag_name" class="block text-sm font-medium text-gray-700 mb-1">Tag Name</label>
                        <input type="text" id="new_tag_name" name="new_tag_name"
                            class="w-full p-2 border border-gray-300 rounded-md">

                        <label for="new_tag_category" class="block text-sm font-medium text-gray-700 mt-4 mb-1">Assign
                            to Category</label>
                        <select id="new_tag_category" name="target_category_id"
                            class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="uncategorized" selected>Uncategorized</option>
                            {% for category in tag_categories %}
                            {% if category.name.lower() != 'uncategorized' %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                        <button type="button" onclick="hideModal('addTagModal')"
                            class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create Tag</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editTitleModal"
            class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                <form action="{{ url_for('update_title', filter=request.args.getlist('filter'), state=current_state) }}"
                    method="post" class="w-full">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-xl font-semibold">Edit Document Title</h3>
                        <button type="button" onclick="hideModal('editTitleModal')"
                            class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                    <div class="p-6">
                        <label for="documentTitle" class="block text-sm font-medium text-gray-700 mb-1">Document
                            Title</label>
                        <input type="text" id="documentTitle" name="documentTitle" value="{{ document.documentTitle }}"
                            class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                        <button type="button" onclick="hideModal('editTitleModal')"
                            class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save
                            Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editSectionModal"
            class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start p-4 hidden opacity-0 overflow-y-auto">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg my-4">
                <form id="editSectionForm" method="post" class="w-full">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-xl font-semibold">Edit Section</h3><button type="button"
                            onclick="hideModal('editSectionModal')"
                            class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label for="editSectionTitle" class="block text-sm font-medium text-gray-700 mb-1">Section
                                Title</label>
                            <input type="text" id="editSectionTitle" name="sectionTitle"
                                class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                            <div class="relative">
                                <div id="editSectionTagsContainer"
                                    class="flex flex-wrap items-center w-full p-1 border border-gray-300 rounded-md bg-white min-h-[42px] relative">
                                    {# Defensive: Only render tag/category bubbles if 'section' is defined #}
                                    {% if section is defined %}
                                    {% set all_tag_bubbles = [] %}
                                    {% for tag in section.tags %}
                                    {% set _ = all_tag_bubbles.append({'type': 'tag', 'value': tag}) %}
                                    {% endfor %}
                                    {% if section.categories %}
                                    {% for cat_id in section.categories %}
                                    {% set cat_obj = (tag_categories | selectattr('id', 'equalto', cat_id) | list |
                                    first) %}
                                    {% set cat_name = cat_obj.name if cat_obj else cat_id %}
                                    {% set _ = all_tag_bubbles.append({'type': 'category', 'value': cat_name}) %}
                                    {% endfor %}
                                    {% endif %}
                                    {% for bubble in all_tag_bubbles %}
                                    {% if bubble.type == 'category' %}
                                    <span
                                        class="tag-bubble bg-green-100 text-green-800 mr-2 mb-1 px-2.5 py-1 rounded-full flex items-center">
                                        <span class="mr-1">📁</span>{{ bubble.value }}
                                    </span>
                                    {% else %}
                                    <span
                                        class="tag-bubble bg-blue-100 text-blue-800 mr-2 mb-1 px-2.5 py-1 rounded-full">{{
                                        bubble.value }}</span>
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                    <input type="text" id="editSectionTagsInput"
                                        class="flex-grow p-1 outline-none text-sm" autocomplete="off"
                                        placeholder="Add a tag...">
                                </div>
                                <input type="hidden" id="editSectionTags" name="tags">
                                <input type="hidden" id="editSectionCategories" name="categories">
                                <div id="section-suggestions"
                                    class="tag-suggestions absolute left-0 z-10 w-full bg-white border border-gray-300 rounded-md hidden shadow-lg">
                                    {# Only show all categories for suggestion, avoid referencing undefined section #}
                                    {% for category in tag_categories %}
                                    <div class="tag-suggestion-item" data-type="category" data-id="{{ category.id }}"
                                        data-value="{{ category.name }}">
                                        <span class="mr-1">📁</span>{{ category.name }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div>
                            <!-- Category selection removed as requested -->
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                        <button type="button" onclick="hideModal('editSectionModal')"
                            class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save
                            Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editNoteModal"
            class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start p-4 hidden opacity-0 overflow-y-auto">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl modal-container my-4">
                <form id="editNoteForm" method="post" class="w-full flex flex-col h-full">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="text-xl font-semibold">Edit Note</h3>
                        <div class="flex items-center gap-4">
                            <button type="button" onclick="cleanActiveEditorContent('note')" title="Clean empty lines"
                                class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M3 21h18" />
                                    <path d="M19 21V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v14" />
                                    <path d="M9 10l6 6" />
                                    <path d="M15 10l-6 6" />
                                </svg>
                            </button>
                            <div id="editor-toggle-buttons" class="flex items-center rounded-md">
                                <button type="button" onclick="toggleEditorView('richtext')"
                                    class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-l-md"
                                    title="Rich Text Editor">Rich Text</button>
                                <button type="button" onclick="toggleEditorView('html')"
                                    class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200"
                                    title="HTML Source Code">HTML</button>
                                <button type="button" onclick="toggleEditorView('preview')"
                                    class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-r-md"
                                    title="Preview Content">Preview</button>
                            </div>
                                                            <button type="button" onclick="hideModal('editNoteModal')"
                                class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4 modal-body">
                        <div><label for="editNoteTitle" class="block text-sm font-medium text-gray-700 mb-1">Note
                                Title</label><input type="text" id="editNoteTitle" name="noteTitle"
                                class="w-full p-2 border border-gray-300 rounded-md"></div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                            <div id="quill-editor-container">
                                <div id="quill-editor"></div>
                            </div>
                            <textarea id="html-editor"
                                class="w-full p-2 border border-gray-300 rounded-md h-64 font-mono text-sm hidden"></textarea>
                            <div id="quill-preview-container"
                                class="prose max-w-none p-2 border border-gray-300 rounded-md bg-gray-50 min-h-[240px] hidden">
                            </div>
                            <textarea id="editNoteContent" name="content" class="hidden"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                            <div class="relative">
                                <div id="editNoteTagsContainer"
                                    class="flex flex-wrap items-center w-full p-1 border border-gray-300 rounded-md bg-white min-h-[42px] relative">
                                    {# Defensive: Only render tag/category bubbles if 'note' is defined #}
                                    {% if note is defined %}
                                    {% set all_tag_bubbles = [] %}
                                    {% for tag in note.tags %}
                                    {% set _ = all_tag_bubbles.append({'type': 'tag', 'value': tag}) %}
                                    {% endfor %}
                                    {% if note.categories %}
                                    {% for cat_id in note.categories %}
                                    {% set cat_obj = (tag_categories | selectattr('id', 'equalto', cat_id) | list |
                                    first) %}
                                    {% set cat_name = cat_obj.name if cat_obj else cat_id %}
                                    {% set _ = all_tag_bubbles.append({'type': 'category', 'value': cat_name}) %}
                                    {% endfor %}
                                    {% endif %}
                                    {% for bubble in all_tag_bubbles %}
                                    {% if bubble.type == 'category' %}
                                    <span
                                        class="tag-bubble bg-yellow-100 text-yellow-800 mr-2 mb-1 px-2.5 py-1 rounded-full flex items-center">
                                        <span class="mr-1">🏷️</span>{{ bubble.value }}
                                    </span>
                                    {% else %}
                                    <span
                                        class="tag-bubble bg-blue-100 text-blue-800 mr-2 mb-1 px-2.5 py-1 rounded-full">{{
                                        bubble.value }}</span>
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                    <input type="text" id="editNoteTagsInput" class="flex-grow p-1 outline-none text-sm"
                                        autocomplete="off" placeholder="Add a tag...">
                                </div>
                                <input type="hidden" id="editNoteTags" name="tags">
                                <div id="note-suggestions"
                                    class="tag-suggestions absolute left-0 z-10 w-full bg-white border border-gray-300 rounded-md hidden shadow-lg">
                                    {# Only show all categories for suggestion, avoid referencing undefined note #}
                                    {% for category in tag_categories %}
                                    <div class="tag-suggestion-item" data-type="category" data-id="{{ category.id }}"
                                        data-value="{{ category.name }}">
                                        <span class="mr-1">📁</span>{{ category.name }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div>
                            <!-- Category selection removed as requested -->
                        </div>
                        <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg border-t">
                            <button type="button"
                                onclick="hideModal('editNoteModal')"
                                class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                            <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save
                                Changes</button>
                        </div>
                </form>
            </div>
        </div>
    </div>

    <div id="renameTagModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form
                action="{{ url_for('rename_global_tag', filter=request.args.getlist('filter'), state=current_state) }}"
                method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Rename Tag</h3><button type="button"
                        onclick="hideModal('renameTagModal')"
                        class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="renameOldTag" name="old_tag">
                    <div>
                        <label for="renameNewTag" class="block text-sm font-medium text-gray-700 mb-1">New name for
                            <strong id="oldTagName"></strong></label>
                        <input type="text" id="renameNewTag" name="new_tag"
                            class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('renameTagModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editAndTagModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form id="editAndTagForm"
                action="{{ url_for('update_and_tag', filter=request.args.getlist('filter'), state=current_state) }}"
                method="post" class="w-full"
                onsubmit="console.log('Form submitted'); return updateAndTagFromComponents()">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Edit AND Tag</h3>
                    <button type="button" onclick="hideModal('editAndTagModal')"
                        class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="editAndTagOldTag" name="old_tag">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Edit components for <strong
                                id="oldAndTagName"></strong>:</label>
                        <div id="andTagComponentsContainer" class="space-y-3">
                            <!-- Dynamic component inputs will be added here -->
                        </div>
                        <button type="button" onclick="addAndTagComponent()"
                            class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="mr-1">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Component
                        </button>
                    </div>

                    <input type="hidden" id="editAndTagNewTag" name="new_tag">
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('editAndTagModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addAndTagModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('add_and_tag', filter=request.args.getlist('filter'), state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Create AND Tag</h3>
                    <button type="button" onclick="hideModal('addAndTagModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Enter tag components (note must have <strong>ALL</strong>):</label>
                    <div id="newAndTagComponentsContainer" class="space-y-3">
                        <div class="flex items-center space-x-2 mb-2 and-tag-component">
                            <input type="text" class="and-tag-input w-full p-2 border border-gray-300 rounded-md" placeholder="Tag component 1" autocomplete="off" onfocus="showTagSuggestions(this)" oninput="showTagSuggestions(this)">
                            <div class="tag-suggestions absolute left-0 z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg" style="display:none;"></div>
                            <button type="button" class="remove-and-tag-component p-1 rounded-full hover:bg-gray-200" title="Remove component" onclick="removeAndTagComponent(this)">&times;</button>
                        </div>
                        <div class="flex items-center space-x-2 mb-2 and-tag-component">
                            <input type="text" class="and-tag-input w-full p-2 border border-gray-300 rounded-md" placeholder="Tag component 2" autocomplete="off" onfocus="showTagSuggestions(this)" oninput="showTagSuggestions(this)">
                            <div class="tag-suggestions absolute left-0 z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg" style="display:none;"></div>
                            <button type="button" class="remove-and-tag-component p-1 rounded-full hover:bg-gray-200" title="Remove component" onclick="removeAndTagComponent(this)">&times;</button>
                        </div>
                    </div>
                    <button type="button" onclick="addNewAndTagComponent()" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Component
                    </button>
                    <div class="text-xs text-gray-500 mt-2">You can add or remove components. At least two are required.</div>
                    <!-- AND Tag Preview -->
                    <div id="andTagPreview" class="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-md hidden">
                        <label class="block text-sm font-medium text-orange-800 mb-2">Preview:</label>
                        <div id="andTagPreviewText" class="text-orange-700 font-mono text-sm"></div>
                        <div id="andTagPreviewHelp" class="text-xs text-orange-600 mt-1">This will show content tagged with ALL of the above components</div>
                    </div>
                    <input type="hidden" id="newAndTagComponents" name="and_tag_components">
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('addAndTagModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create AND Tag</button>
                </div>
            </form>
        </div>
    </div>

    <div id="createStateModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('create_state') }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Create New State</h3>
                    <button type="button" onclick="hideModal('createStateModal')"
                        class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6">
                    <label for="new_state_name" class="block text-sm font-medium text-gray-700 mb-1">State Name</label>
                    <input type="text" id="new_state_name" name="state_name"
                        class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('createStateModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create
                        State</button>
                </div>
            </form>
        </div>
    </div>

    <div id="renameStateModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('rename_state') }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Rename State</h3><button type="button"
                        onclick="hideModal('renameStateModal')"
                        class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="renameOldStateName" name="old_state_name">
                    <div>
                        <label for="renameNewStateName" class="block text-sm font-medium text-gray-700 mb-1">New name
                            for <strong id="oldStateName"></strong></label>
                        <input type="text" id="renameNewStateName" name="new_state_name"
                            class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('renameStateModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addCategoryModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('add_category', state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Create New Category</h3>
                    <button type="button" onclick="hideModal('addCategoryModal')"
                        class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6">
                    <label for="new_category_name" class="block text-sm font-medium text-gray-700 mb-1">Category
                        Name</label>
                    <input type="text" id="new_category_name" name="category_name"
                        class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('addCategoryModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create
                        Category</button>
                </div>
            </form>
        </div>
    </div>

    <div id="renameCategoryModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('rename_category', state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Rename Category</h3><button type="button"
                        onclick="hideModal('renameCategoryModal')"
                        class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="renameOldCategoryId" name="category_id">
                    <div>
                        <label for="renameNewCategoryName" class="block text-sm font-medium text-gray-700 mb-1">New name
                            for <strong id="oldCategoryName"></strong></label>
                        <input type="text" id="renameNewCategoryName" name="new_category_name"
                            class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('renameCategoryModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </form>
        </div>
    </div>


    <div id="importModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start p-4 hidden opacity-0 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl modal-container my-4">
            <form id="importForm"
                action="{{ url_for('import_html', filter=request.args.getlist('filter'), state=current_state) }}"
                method="post" class="w-full flex flex-col h-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Import Content</h3>
                    <div class="flex items-center gap-4">
                        <label for="docx-file-input" class="file-input-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="mr-2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            Import .docx
                        </label>
                        <input type="file" id="docx-file-input" class="hidden" accept=".docx">
                        <button type="button" onclick="hideModal('importModal')"
                            class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                </div>
                <div class="p-6 space-y-4 modal-body">
                    <div>
                        <label for="importDocumentTitle" class="block text-sm font-medium text-gray-700 mb-1">Document Title</label>
                        <input type="text" id="importDocumentTitle" name="document_title" 
                               class="w-full p-2 border border-gray-300 rounded-md text-sm" 
                               placeholder="Enter document title...">
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <div id="import-editor-toggle-buttons" class="flex items-center rounded-md">
                            <button type="button" onclick="toggleImportEditorView('richtext')"
                                class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-l-md"
                                title="Rich Text Editor">Rich Text</button>
                            <button type="button" onclick="toggleImportEditorView('html')"
                                class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-r-md"
                                title="HTML Source Code">HTML</button>
                        </div>
                        <button type="button" onclick="cleanActiveEditorContent('import')" title="Clean empty lines"
                            class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M3 21h18" />
                                <path d="M19 21V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v14" />
                                <path d="M9 10l6 6" />
                                <path d="M15 10l-6 6" />
                            </svg>
                        </button>
                    </div>
                    <div id="import-progress-bar-container" class="w-full mb-4 hidden">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="import-progress-bar"
                                class="bg-blue-600 h-4 rounded-full transition-all duration-300 ease-in-out"
                                style="width: 0%"></div>
                        </div>
                        <div id="import-progress-label"
                            class="text-sm text-blue-700 mt-2 text-center font-semibold tracking-wide"></div>
                    </div>
                    <div id="import-editor-container">
                        <div id="import-editor"></div>
                    </div>
                    <textarea id="html-import-editor"
                        class="w-full p-2 border border-gray-300 rounded-md font-mono text-sm hidden"
                        placeholder="Paste your HTML here..."></textarea>
                    <input type="hidden" id="import_html_content" name="html_content">
                </div>
                <div class="p-4 bg-gray-50 flex justify-end items-center space-x-3 rounded-b-lg border-t">
                    <div class="flex items-center gap-4 mr-auto">
                        <span class="text-sm font-semibold text-gray-700">Import Mode:</span>
                        <label class="flex items-center text-sm"><input type="radio" name="import_mode"
                                value="overwrite" class="form-radio" checked><span class="ml-2">Overwrite</span></label>
                        <label class="flex items-center text-sm"><input type="radio" name="import_mode"
                                value="aggregate" class="form-radio"><span class="ml-2">Add to end</span></label>
                    </div>
                    <button type="button" onclick="hideModal('importModal')"
                        class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="submit-import-btn"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Import</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Expose global variables from Flask to the window object for your JS modules
        // Note: This script must remain inline as it contains server-side template variables
        window.ALL_TAGS = JSON.parse('{{ all_tag_suggestions | tojson | safe }}');
        window.TAG_CATEGORIES = JSON.parse('{{ tag_categories | tojson | safe }}');
        window.CURRENT_STATE = '{{ current_state | safe }}';
        window.ACTIVE_FILTERS_LOWER = JSON.parse('{{ active_filters_lower | tojson | safe }}');

        console.log('Global variables set:', {
            ALL_TAGS: window.ALL_TAGS?.length || 0,
            TAG_CATEGORIES: window.TAG_CATEGORIES?.length || 0,
            CURRENT_STATE: window.CURRENT_STATE,
            ACTIVE_FILTERS_LOWER: window.ACTIVE_FILTERS_LOWER?.length || 0,
            Quill: typeof Quill !== 'undefined'
        });

        // Initialize modal system immediately
        window.addEventListener('DOMContentLoaded', function () {
            console.log('DOM Content Loaded - Setting up modals');

            // Ensure basic modal functions exist immediately
            // Removed legacy modal fallback system: all modal logic now handled by modals.js and editors.js
            window.showAddAndTagModal = showAddAndTagModal;
        });
    </script>

    <!-- Load JavaScript modules -->
    <script src="{{ url_for('static', filename='js/logger.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tag-input-global.js') }}"></script>
    <!-- Removed duplicate drag_drop.js script -->
    <!-- Remove duplicate drag_drop.js script at the end of body -->
    <script src="{{ url_for('static', filename='js/modals.js') }}"></script>

    <!-- Initialize Editors after all scripts are loaded -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize editors now that all scripts are loaded
            if (typeof initializeEditors === 'function') {
        
                window.appLogger?.componentStatus('EDITORS', 'initializing');
                initializeEditors();
                window.appLogger?.componentStatus('EDITORS', 'initialized');
            } else {
                console.error('❌ initializeEditors function not found');
            }
        });
    </script>

    <!-- Comprehensive Action Tracking -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Track all button clicks
            document.addEventListener('click', function (event) {
                const element = event.target;

                if (element.tagName === 'BUTTON' || element.type === 'submit') {
                    const buttonData = {
                        id: element.id,
                        className: element.className,
                        textContent: element.textContent?.trim(),
                        type: element.type,
                        formAction: element.form?.action,
                        onclick: element.getAttribute('onclick')
                    };

                    window.appLogger?.buttonClick('BUTTON_CLICKED', buttonData);
                }

                // Track link clicks
                if (element.tagName === 'A') {
                    window.appLogger?.buttonClick('LINK_CLICKED', {
                        href: element.href,
                        textContent: element.textContent?.trim(),
                        id: element.id,
                        className: element.className
                    });
                }

                // Track select changes
                if (element.tagName === 'SELECT') {
                    window.appLogger?.action('SELECT_CHANGED', {
                        id: element.id,
                        value: element.value,
                        selectedText: element.options[element.selectedIndex]?.text
                    });
                }
            });

            // Track form submissions
            document.addEventListener('submit', function (event) {
                const form = event.target;
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                window.appLogger?.action('FORM_SUBMITTED', {
                    formId: form.id,
                    action: form.action,
                    method: form.method,
                    data: data
                });
            });

            // Track input changes
            document.addEventListener('change', function (event) {
                const element = event.target;
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    window.appLogger?.action('INPUT_CHANGED', {
                        id: element.id,
                        name: element.name,
                        type: element.type,
                        value: element.type === 'password' ? '[HIDDEN]' : element.value?.substring(0, 100) // Truncate long values
                    });
                }
            });

            // Track modal dialog interactions
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const element = mutation.target;
                        if (element.classList.contains('modal')) {
                            const isVisible = !element.classList.contains('hidden') && !element.classList.contains('opacity-0');
                            window.appLogger?.action('MODAL_VISIBILITY_CHANGED', {
                                modalId: element.id,
                                visible: isVisible,
                                classList: Array.from(element.classList)
                            });
                        }
                    }
                });
            });

            // Observe all modal elements
            document.querySelectorAll('.modal').forEach(modal => {
                observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
            });

            // Log page initialization complete
            window.appLogger?.action('PAGE_INITIALIZED', {
                url: window.location.href,
                title: document.title,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            });
        });

        // AND Tag Component Management Functions
        let andTagComponentCount = 0;

        function showAddAndTagModal() {
            // Clear previous components and reset counter
            const container = document.getElementById('newAndTagComponentsContainer');
            container.innerHTML = '';
            andTagComponentCount = 0;

            // Clear any previous tag input references
            Object.keys(window.tagInputs || {}).forEach(key => {
                if (key.startsWith('andTagInput_')) {
                    delete window.tagInputs[key];
                }
            });

            // Hide preview initially
            document.getElementById('andTagPreview').classList.add('hidden');

            // Add initial two components
            addNewAndTagComponent();
            addNewAndTagComponent();

            window.showModal('addAndTagModal');
            window.appLogger?.action('MODAL_OPENED', {
                modalId: 'addAndTagModal',
                context: 'create_and_tag'
            });
        }

        function addNewAndTagComponent() {
            const container = document.getElementById('newAndTagComponentsContainer');
            andTagComponentCount++;

            const componentDiv = document.createElement('div');
            componentDiv.className = 'flex items-center space-x-2';
            componentDiv.id = `andTagComponent_${andTagComponentCount}`;

            const inputId = `andTagInput_${andTagComponentCount}`;
            const containerId = `andTagInputContainer_${andTagComponentCount}`;
            const suggestionsId = `andTagSuggestions_${andTagComponentCount}`;

            componentDiv.innerHTML = `
        <div class="flex-1 relative">
            <div id="${containerId}" class="flex flex-wrap items-center w-full p-1 border border-gray-300 rounded-md bg-white min-h-[42px] relative">
                <input type="text" 
                       id="${inputId}"
                       placeholder="Enter tag component (e.g., Python, Database, API)"
                       class="flex-grow p-1 outline-none text-sm"
                       autocomplete="off"
                       data-single-tag="true">
            </div>
            <div id="${suggestionsId}" class="tag-suggestions absolute left-0 z-10 w-full bg-white border border-gray-300 rounded-md hidden shadow-lg"></div>
        </div>
        <button type="button" 
                onclick="removeAndTagComponent('andTagComponent_${andTagComponentCount}')"
                class="px-2 py-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors"
                title="Remove component">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    `;

            container.appendChild(componentDiv);

            // Initialize the tag input system for this component with single tag limit
            const newInput = document.getElementById(inputId);
            if (newInput && window.createTagInput) {
                // Create a hidden input for the tag system
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = `${inputId}_hidden`;
                componentDiv.appendChild(hiddenInput);

                // Initialize the tag input system
                const tagInput = window.createTagInput(containerId, inputId, `${inputId}_hidden`, suggestionsId);

                // Modify the tag input to only allow one tag
                const originalAddTag = tagInput.addTag;
                tagInput.addTag = function (tag) {
                    // Clear existing tags first to ensure only one tag
                    this.tags = [];
                    originalAddTag.call(this, tag);
                    // Hide input after adding a tag but don't disable it
                    newInput.style.display = 'none';
                    // Keep the input value for form submission
                    newInput.value = tag;
                };

                // Modify the removeTag function to show input again
                const originalRemoveTag = tagInput.removeTag;
                tagInput.removeTag = function (tag) {
                    originalRemoveTag.call(this, tag);
                    // Show input again when tag is removed
                    newInput.style.display = 'block';
                    newInput.value = '';
                    newInput.focus();
                };

                tagInput.init([]);

                // Store reference for later use
                window.tagInputs[inputId] = tagInput;

                // Add event listener to update preview when tags change
                const originalRender = tagInput.render;
                tagInput.render = function () {
                    originalRender.call(this);
                    // Update preview after any tag changes
                    setTimeout(() => updateAndTagPreview(), 10);
                };

                console.log(`[NEW AND TAG] Initialized single-tag input for component ${andTagComponentCount}`);
            }

            // Focus the new input
            if (newInput) {
                newInput.focus();
            }

            // Update preview
            updateAndTagPreview();

            window.appLogger?.action('AND_TAG_COMPONENT_ADDED', {
                componentId: `andTagComponent_${andTagComponentCount}`,
                totalComponents: container.children.length
            });
        }

        function removeAndTagComponent(componentId) {
            const component = document.getElementById(componentId);
            if (component) {
                const container = document.getElementById('newAndTagComponentsContainer');

                // Don't allow removing if only 2 components remain
                if (container.children.length <= 2) {
                    alert('AND tags must have at least 2 components.');
                    return;
                }

                // Clean up tag input reference
                const input = component.querySelector('[id^="andTagInput_"]');
                if (input && window.tagInputs[input.id]) {
                    delete window.tagInputs[input.id];
                }

                component.remove();

                // Update preview after removal
                updateAndTagPreview();

                window.appLogger?.action('AND_TAG_COMPONENT_REMOVED', {
                    componentId: componentId,
                    remainingComponents: container.children.length
                });
            }
        }

        // ...existing code...

        function updateAndTagPreview() {
            const container = document.getElementById('newAndTagComponentsContainer');
            const components = [];
            const duplicates = [];



            // Get all component values from the tag input system - exclude hidden inputs
            container.querySelectorAll('[id^="andTagInput_"]:not([id$="_hidden"])').forEach(input => {
                const inputId = input.id;
                const tagInput = window.tagInputs[inputId];

                let value = '';
                if (tagInput && tagInput.tags && tagInput.tags.length > 0) {
                    // Use the first tag from the tag input system
                    value = tagInput.tags[0];
                } else {
                    // Fallback to direct input value
                    value = input.value.trim();
                }



                if (value) {
                    const lowerValue = value.toLowerCase();
                    if (components.some(comp => comp.toLowerCase() === lowerValue)) {
                        duplicates.push(value);
                        // Add visual indicator for duplicate
                        input.parentElement.parentElement.classList.add('border-red-500');

                    } else {
                        components.push(value);
                        // Remove visual indicator
                        input.parentElement.parentElement.classList.remove('border-red-500');
                    }
                } else {
                    // Remove visual indicator for empty inputs
                    input.parentElement.parentElement.classList.remove('border-red-500');
                }
            });



            const previewDiv = document.getElementById('andTagPreview');
            const previewText = document.getElementById('andTagPreviewText');
            const previewHelp = document.getElementById('andTagPreviewHelp');

            if (components.length >= 2 && duplicates.length === 0) {
                previewDiv.classList.remove('hidden');
                previewDiv.className = 'mt-4 p-3 bg-orange-50 border border-orange-200 rounded-md';
                previewText.textContent = components.join(' & ');
                previewText.className = 'text-orange-700 font-mono text-sm';
                previewHelp.textContent = 'This will show content tagged with ALL of the above components';
                previewHelp.className = 'text-xs text-orange-600 mt-1';
            } else if (duplicates.length > 0) {
                previewDiv.classList.remove('hidden');
                previewDiv.className = 'mt-4 p-3 bg-red-50 border border-red-200 rounded-md';
                previewText.textContent = 'Please remove duplicate components: ' + duplicates.join(', ');
                previewText.className = 'text-red-700 font-mono text-sm';
                previewHelp.textContent = 'Each component must be unique';
                previewHelp.className = 'text-xs text-red-600 mt-1';
            } else {
                previewDiv.classList.add('hidden');
                previewText.textContent = '';
            }
        }

        function createAndTagFromComponents() {
            const container = document.getElementById('newAndTagComponentsContainer');
            const components = [];



            // Get all component values from the tag input system - exclude hidden inputs
            container.querySelectorAll('[id^="andTagInput_"]:not([id$="_hidden"])').forEach(input => {
                const inputId = input.id;
                const tagInput = window.tagInputs[inputId];

                let collectedValue = '';
                let source = '';

                if (tagInput && tagInput.tags && tagInput.tags.length > 0) {
                    // Use the first tag from the tag input system
                    const tag = tagInput.tags[0];
                    if (tag && tag.trim()) {
                        collectedValue = tag.trim();
                        source = 'tagInput.tags[0]';
                        components.push(collectedValue);
                    }
                } else {
                    // Fallback to direct input value
                    const value = input.value.trim();
                    if (value) {
                        collectedValue = value;
                        source = 'input.value';
                        components.push(value);
                    }
                }

            });

            // Validate components
            if (components.length < 2) {
                alert('Please enter at least 2 tag components.');
                return false;
            }

            // Check for duplicates
            const uniqueComponents = [...new Set(components.map(c => c.toLowerCase()))];


            if (uniqueComponents.length !== components.length) {
                alert('Please remove duplicate components.');
                return false;
            }

            // Check if AND tag already exists
            const andTagString = components.join(' & ');
            const existingAndTags = {{ and_tags | tojson | safe
        }};
        if (existingAndTags.includes(andTagString)) {
            alert('An AND tag with these components already exists.');
            return false;
        }

        // Set the hidden input value
        document.getElementById('newAndTagComponents').value = components.join(', ');

        window.appLogger?.action('AND_TAG_CREATED', {
            components: components,
            componentCount: components.length,
            andTagPreview: components.join('&')
        });

        return true; // Allow form submission
// ...existing code...

        // AND Tag Edit Functions
        let editAndTagComponentCount = 0;

        function showEditAndTagModal(tag) {
            try {
                // Decode HTML entities if present
                const decodedTag = tag.replace(/&amp;/g, '&');

                // Reset component counter
                editAndTagComponentCount = 0;

                // Clear any previous tag input references for edit modal
                Object.keys(window.tagInputs || {}).forEach(key => {
                    if (key.startsWith('editAndTagInput_')) {
                        delete window.tagInputs[key];
                    }
                });

                // Set the old tag values
                document.getElementById('editAndTagOldTag').value = decodedTag;
                document.getElementById('oldAndTagName').textContent = decodedTag;

                // Clear the components container
                const container = document.getElementById('andTagComponentsContainer');
                container.innerHTML = '';

                // Parse existing components from the tag
                const components = decodedTag.split('&').map(comp => comp.trim());

                // Add input fields for each existing component
                components.forEach(component => {
                    addAndTagComponent(component);
                });

                // Show the modal
                window.showModal('editAndTagModal');

                window.appLogger?.action('MODAL_OPENED', {
                    modalId: 'editAndTagModal',
                    context: 'edit_and_tag',
                    originalTag: decodedTag
                });
            } catch (error) {
                console.error('Error showing edit AND tag modal:', error);
                if (window.logModalError) {
                    window.logModalError('showEditAndTagModal', 'editAndTagModal', error);
                }
            }
        }

        function addAndTagComponent(initialValue = '') {
            const container = document.getElementById('andTagComponentsContainer');
            editAndTagComponentCount++;

            const componentDiv = document.createElement('div');
            componentDiv.className = 'flex items-center space-x-2';
            componentDiv.id = `editAndTagComponent_${editAndTagComponentCount}`;

            const inputId = `editAndTagInput_${editAndTagComponentCount}`;
            const containerId = `editAndTagInputContainer_${editAndTagComponentCount}`;
            const suggestionsId = `editAndTagSuggestions_${editAndTagComponentCount}`;

            componentDiv.innerHTML = `
        <div class="flex-1 relative">
            <div id="${containerId}" class="flex flex-wrap items-center w-full p-1 border border-gray-300 rounded-md bg-white min-h-[42px] relative">
                <input type="text" 
                       id="${inputId}"
                       value="${initialValue}"
                       placeholder="Enter tag component (e.g., Python, Database, API)"
                       class="flex-grow p-1 outline-none text-sm"
                       autocomplete="off"
                       data-single-tag="true">
            </div>
            <div id="${suggestionsId}" class="tag-suggestions absolute left-0 z-10 w-full bg-white border border-gray-300 rounded-md hidden shadow-lg"></div>
        </div>
        <button type="button" 
                onclick="removeEditAndTagComponent('editAndTagComponent_${editAndTagComponentCount}')"
                class="px-2 py-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors"
                title="Remove component">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    `;

            container.appendChild(componentDiv);

            // Initialize the tag input system for this component with single tag limit
            const newInput = document.getElementById(inputId);
            if (newInput && window.createTagInput) {
                // Create a hidden input for the tag system
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = `${inputId}_hidden`;
                componentDiv.appendChild(hiddenInput);

                // Initialize the tag input system
                const tagInput = window.createTagInput(containerId, inputId, `${inputId}_hidden`, suggestionsId);

                // Modify the tag input to only allow one tag
                const originalAddTag = tagInput.addTag;
                tagInput.addTag = function (tag) {
                    // Clear existing tags first to ensure only one tag
                    this.tags = [];
                    originalAddTag.call(this, tag);
                    // Hide input after adding a tag but don't disable it
                    newInput.style.display = 'none';
                    // Keep the input value for form submission
                    newInput.value = tag;
                };

                // Modify the removeTag function to show input again
                const originalRemoveTag = tagInput.removeTag;
                tagInput.removeTag = function (tag) {
                    originalRemoveTag.call(this, tag);
                    // Show input again when tag is removed
                    newInput.style.display = 'block';
                    newInput.value = '';
                    newInput.focus();
                };

                // Set initial value if provided
                if (initialValue) {
                    tagInput.init([initialValue]);
                    // Hide input since we have a tag
                    newInput.style.display = 'none';
                    newInput.value = initialValue;
                } else {
                    tagInput.init([]);
                }

                // Store reference for later use
                window.tagInputs[inputId] = tagInput;

                console.log(`[EDIT AND TAG] Initialized single-tag input for component ${editAndTagComponentCount}`);
            }

            // Focus if this is a new empty component
            if (!initialValue && newInput) {
                newInput.focus();
            }

            window.appLogger?.action('EDIT_AND_TAG_COMPONENT_ADDED', {
                componentId: `editAndTagComponent_${editAndTagComponentCount}`,
                totalComponents: container.children.length,
                initialValue: initialValue
            });
        }

        function removeEditAndTagComponent(componentId) {
            const component = document.getElementById(componentId);
            if (component) {
                const container = document.getElementById('andTagComponentsContainer');

                // Don't allow removing if only 2 components remain
                if (container.children.length <= 2) {
                    alert('AND tags must have at least 2 components.');
                    return;
                }

                // Clean up tag input reference
                const input = component.querySelector('[id^="editAndTagInput_"]');
                if (input && window.tagInputs[input.id]) {
                    delete window.tagInputs[input.id];
                }

                component.remove();

                window.appLogger?.action('EDIT_AND_TAG_COMPONENT_REMOVED', {
                    componentId: componentId,
                    remainingComponents: container.children.length
                });
            }
        }

        function updateAndTagFromComponents() {
    

            const container = document.getElementById('andTagComponentsContainer');
            const components = [];



            // Get all component values - try multiple approaches
            const componentDivs = container.querySelectorAll('[id^="editAndTagComponent_"]');


            componentDivs.forEach(div => {
                const input = div.querySelector('[id^="editAndTagInput_"]');
                const hiddenInput = div.querySelector('[id$="_hidden"]');



                // Try to get value from multiple sources
                let componentValue = '';

                // First try the tag input system
                if (input) {
                    const tagInput = window.tagInputs[input.id];
                    if (tagInput && tagInput.tags && tagInput.tags.length > 0) {
                        componentValue = tagInput.tags[0].trim();

                    }
                }

                // Fallback to hidden input
                if (!componentValue && hiddenInput && hiddenInput.value) {
                    componentValue = hiddenInput.value.trim();

                }

                // Final fallback to direct input value
                if (!componentValue && input && input.value) {
                    componentValue = input.value.trim();

                }

                if (componentValue) {
                    components.push(componentValue);
                }
            });



            // Validate components
            if (components.length < 2) {
                console.log('[DEBUG] Validation failed: less than 2 components');
                alert('Please enter at least 2 tag components.');
                return false;
            }

            // Check for duplicates
            const uniqueComponents = [...new Set(components.map(c => c.toLowerCase()))];
            if (uniqueComponents.length !== components.length) {
                console.log('[DEBUG] Validation failed: duplicate components');
                alert('Please remove duplicate components.');
                return false;
            }

            // Check if new AND tag already exists (excluding the current one being edited)
            const oldTag = document.getElementById('editAndTagOldTag').value;
            const newAndTagString = components.join(' & ');
            const existingAndTags = {{ and_tags | tojson | safe
        }};

        console.log('[DEBUG] Tag comparison:', {
            oldTag,
            newAndTagString,
            existingAndTags
        });

        if (newAndTagString !== oldTag && existingAndTags.includes(newAndTagString)) {
            console.log('[DEBUG] Validation failed: AND tag already exists');
            alert('An AND tag with these components already exists.');
            return false;
        }

        // Set the hidden input value
        document.getElementById('editAndTagNewTag').value = components.join(', ');

        console.log('[DEBUG] Validation passed, form should submit');
        console.log('[DEBUG] Hidden input value set to:', document.getElementById('editAndTagNewTag').value);

        window.appLogger?.action('AND_TAG_UPDATED', {
            oldTag: oldTag,
            newComponents: components,
            componentCount: components.length,
            newAndTag: newAndTagString
        });

        return true; // Allow form submission
// ...existing code...

        function deleteAndTag(tagName, deleteUrl) {
            console.log('deleteAndTag called for:', tagName);

            if (confirm(`Are you sure you want to delete the AND tag '${tagName}'?`)) {
                console.log('User confirmed deletion, submitting form...');

                // Log the deletion event
                const activeFilters = {{ request.args.getlist('filter') | tojson | safe }};
            // ...existing code...
        const isActiveFilter = activeFilters.map(f => f.toLowerCase()).includes(tagName.toLowerCase());

        window.appLogger?.action('AND_TAG_DELETED', {
            tagName: tagName,
            activeFilters: activeFilters,
            isActiveFilter: isActiveFilter
        });

        // Create and submit a form programmatically
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = deleteUrl;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'and_tag_to_delete';
        input.value = tagName;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    } else {
            console.log('User cancelled deletion');
        }
}
    </script>

</body>
<script src="{{ url_for('static', filename='js/drag_drop.js') }}"></script>
<script src="{{ url_for('static', filename='js/find-in-text.js') }}"></script>
<script>
    // Show last submitted categories after reload (from localStorage or cookie)
    window.addEventListener('DOMContentLoaded', function () {
        var lastCategories = null;
        try {
            lastCategories = window.localStorage.getItem('lastSubmittedCategories');
        } catch (e) { }
        if (!lastCategories) {
            // Try cookie fallback
            var match = document.cookie.match(/(?:^|; )lastSubmittedCategories=([^;]*)/);
            if (match) {
                lastCategories = decodeURIComponent(match[1]);
            }
        }
        if (lastCategories) {
            var infoDiv = document.createElement('div');
            infoDiv.style.cssText = 'background:#fef3c7;color:#92400e;padding:8px 16px;margin:12px 0;border-radius:6px;font-size:1rem;font-weight:500;z-index:9999;';
            infoDiv.textContent = '[TAG INPUT] Last submitted categories: ' + lastCategories;
            document.body.insertBefore(infoDiv, document.body.firstChild);
        }
    });
</script>
<!-- START FROM MODAL FOR ORDERED LISTS -->
<div id="olStartFromModal"
    class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xs">
        <form id="olStartFromForm" class="w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Set List Start Number</h3>
                <button type="button" onclick="hideModal('olStartFromModal')"
                    class="p-1 rounded-full hover:bg-gray-200">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <label for="olStartFromInput" class="block text-sm font-medium text-gray-700 mb-1">Start from:</label>
                <input type="number" id="olStartFromInput" name="start" min="1"
                    class="w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button type="button" onclick="hideModal('olStartFromModal')"
                    class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </form>
    </div>
</div>

</html>