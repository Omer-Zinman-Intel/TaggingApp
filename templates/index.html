<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ document.documentTitle }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body class="bg-gray-50">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8 my-8">

        <div class="flex items-center group mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-800">{{ document.documentTitle }}</h1>
            <button onclick="showModal('editTitleModal')" class="ml-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 hover:text-blue-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
        </div>

        <div class="bg-gray-100 p-4 rounded-lg mb-6">
            <div class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b">
                <h3 class="text-sm font-semibold text-gray-600">CURRENT STATE:</h3>
                <select onchange="window.location.href = this.value" class="p-2 border border-gray-300 rounded-md text-sm font-medium">
                    {% for state_name in available_states %}
                        <option value="{{ url_for('index', state=state_name) }}" {% if state_name == current_state %}selected{% endif %}>
                            {{ state_name }}
                        </option>
                    {% endfor %}
                </select>
                <button onclick="showModal('createStateModal')" class="text-sm font-medium text-green-600 bg-green-100 hover:bg-green-200 px-3 py-1.5 rounded-full transition-colors">
                    + New State
                </button>
                <button onclick="showRenameStateModal('{{ current_state }}')" class="text-sm font-medium text-blue-600 bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded-full transition-colors">
                    Rename Current State
                </button>
                <form action="{{ url_for('delete_state') }}" method="post" onsubmit="return confirm('Are you sure you want to delete the state \'{{ current_state }}\'? This action cannot be undone.');" class="inline">
                    <input type="hidden" name="state_to_delete" value="{{ current_state }}">
                    <button type="submit" class="text-sm font-medium text-red-600 bg-red-100 hover:bg-red-200 px-3 py-1.5 rounded-full transition-colors">
                        Delete Current State
                    </button>
                </form>
            </div>
            
            <div class="pt-4">
                <h3 class="text-sm font-semibold text-gray-600 mb-2">TAG CATEGORIES</h3>
                <div class="flex items-center gap-2 mb-4">
                    <button onclick="showModal('addCategoryModal')" class="text-sm font-medium text-purple-600 bg-purple-100 hover:bg-purple-200 px-3 py-1.5 rounded-full transition-colors">
                        + New Category
                    </button>
                </div>
                
                {% if and_tags %}
                <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                    <div class="flex justify-between items-center tag-category-header">
                        <h4 class="font-semibold text-gray-700 flex items-center">
                            AND Tags
                        </h4>
                        <span class="text-xs text-gray-500">{{ and_tags|length }} tags</span>
                    </div>
                    <div id="and-tags-content" class="tag-category-content dropzone flex flex-wrap gap-2 p-2 mt-2"
                         ondragover="allowDrop(event)" ondrop="drop(event)" ondragleave="leaveDrop(event)" data-category-id="and_tags">
                        {% for tag in and_tags %}
                            <span class="tag-bubble and-tag {% if tag.lower() in active_filters_lower %}active-filter{% else %}inactive-filter{% endif %} relative group/tag"
                                  draggable="true" ondragstart="drag(event)" ondragend="dragEnd(event)" ondrop="drop(event)" data-tag-name="{{ tag }}" data-source-category-id="and_tags">
                                <div class="flex flex-col" onclick="handleTagClick(event, '{{ tag }}')" oncontextmenu="showTagContextMenu(event, '{{ tag }}')">
                                    {% for component in tag.split('&') %}
                                        <span class="and-tag-component">
                                            {{ component }} 
                                            <button onclick="event.preventDefault(); event.stopPropagation(); removeAndTagComponent(event, '{{ tag }}', '{{ component }}')" class="and-component-remove-btn">&times;</button>
                                        </span>
                                    {% endfor %}
                                </div>
                            </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                    <div class="flex justify-between items-center tag-category-header">
                        <h4 class="font-semibold text-gray-700 flex items-center">
                            Uncategorized Tags
                        </h4>
                        <span class="text-xs text-gray-500">{{ uncategorized_tags|length }} tags</span>
                    </div>
                    <div id="uncategorized-content" class="tag-category-content dropzone flex flex-wrap gap-2 p-2 mt-2"
                         ondragover="allowDrop(event)" ondrop="drop(event)" ondragleave="leaveDrop(event)" data-category-id="uncategorized">
                        {% for tag in uncategorized_tags %}
                            {% if tag.lower() != 'all' %}
                            <span class="tag-bubble {% if '&' in tag.lower() %}and-tag{% elif tag.lower() in active_filters_lower %}active-filter{% else %}inactive-filter{% endif %} relative group/tag"
                               draggable="{{ 'false' if tag.lower() == 'all' else 'true' }}" ondragstart="drag(event)" ondragend="dragEnd(event)" ondrop="drop(event)" data-tag-name="{{ tag }}" data-source-category-id="uncategorized">
                                <span onclick="handleTagClick(event, '{{ tag }}')" oncontextmenu="showTagContextMenu(event, '{{ tag }}')">{{ tag }}</span>
                                <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-md p-1 flex items-center z-20 opacity-0 group-hover/tag:opacity-100 transition-opacity pointer-events-none group-hover/tag:pointer-events-auto">
                                    <button onclick="event.preventDefault(); event.stopPropagation(); showRenameModal('{{ tag }}')" class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                    <form action="{{ url_for('delete_global_tag', filter=request.args.getlist('filter'), state=current_state) }}" method="post" onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete the tag \'{{ tag }}\' everywhere?');" class="inline">
                                        <input type="hidden" name="tag_to_delete" value="{{ tag }}">
                                        <button type="submit" onclick="event.stopPropagation();" class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded-md">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                        </button>
                                    </form>
                                </div>
                            </span>
                            {% endif %}
                        {% endfor %}
                        {% if not uncategorized_tags %}
                            <span class="text-sm text-gray-500 italic">No uncategorized tags. Drag tags here to unassign them from categories.</span>
                        {% endif %}
                    </div>
                </div>

                {% for category in tag_categories %}
                    {% if category.name.lower() != 'uncategorized' %}
                    <div class="bg-white p-3 rounded-lg shadow-sm mb-3">
                        <div class="flex justify-between items-center tag-category-header">
                            <h4 class="font-semibold text-gray-700 flex items-center">
                                {{ category.name }}
                            </h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">{{ category.tags|length }} tags</span>
                                <button onclick="event.stopPropagation(); showRenameCategoryModal('{{ category.id }}', '{{ category.name }}')" class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-md" title="Rename Category">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <form action="{{ url_for('delete_category', state=current_state) }}" method="post" onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete the category \'{{ category.name }}\'? Its tags will be moved to Uncategorized.');" class="inline">
                                    <input type="hidden" name="category_id_to_delete" value="{{ category.id }}">
                                    <button type="submit" class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded-md" title="Delete Category">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div id="category-{{ category.id }}-content" class="tag-category-content dropzone flex flex-wrap gap-2 p-2 mt-2"
                             ondragover="allowDrop(event)" ondrop="drop(event)" ondragleave="leaveDrop(event)" data-category-id="{{ category.id }}">
                            {% for tag in category.tags %}
                                {% if '&' not in tag %}
                                <span class="tag-bubble {% if '&' in tag.lower() %}and-tag{% elif tag.lower() in active_filters_lower %}active-filter{% else %}inactive-filter{% endif %} relative group/tag"
                                   draggable="{{ 'false' if tag.lower() == 'all' else 'true' }}" ondragstart="drag(event)" ondragend="dragEnd(event)" ondrop="drop(event)" data-tag-name="{{ tag }}" data-source-category-id="{{ category.id }}">
                                    <span onclick="handleTagClick(event, '{{ tag }}')">{{ tag }}</span>
                                    <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-md p-1 flex items-center z-20 opacity-0 group-hover/tag:opacity-100 transition-opacity pointer-events-none group-hover/tag:pointer-events-auto">
                                        <button onclick="event.preventDefault(); event.stopPropagation(); showRenameModal('{{ tag }}')" class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-md">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <form action="{{ url_for('delete_global_tag', filter=request.args.getlist('filter'), state=current_state) }}" method="post" onsubmit="event.stopPropagation(); return confirm('Are you sure you want to delete the tag \'{{ tag }}\' everywhere?');" class="inline">
                                            <input type="hidden" name="tag_to_delete" value="{{ tag }}">
                                            <button type="submit" onclick="event.stopPropagation();" class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded-md">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                            </button>
                                        </form>
                                    </div>
                                </span>
                                {% endif %}
                            {% endfor %}
                            {% if not category.tags %}
                                <span class="text-sm text-gray-500 italic">Drag tags here.</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                <div class="mt-4 flex justify-start">
                    {% if active_filters %}
                        <a href="{{ url_for('index', state=current_state) }}" class="text-sm font-medium text-white bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-full transition-colors">
                            Clear Filters
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div id="content-to-export" class="space-y-6">
            {% for section in sections %}
            <div class="bg-gray-50/70 border border-gray-200/80 p-5 rounded-lg group/section">
                <div class="flex justify-between items-start mb-3">
                    <h2 class="text-xl font-semibold text-gray-800">{{ section.sectionTitle }}</h2>
                    <div class="flex items-center space-x-2 opacity-0 group-hover/section:opacity-100 transition-opacity">
                        <button onclick="showEditSectionModal('{{ section.id }}', '{{ section.sectionTitle }}', '{{ section.tags|join(', ') }}')" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" ><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <form action="{{ url_for('delete_section', section_id=section.id, filter=request.args.getlist('filter'), state=current_state) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this section and all its notes?');" class="inline">
                            <button type="submit" class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-gray-200 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </form>
                    </div>
                </div>

                {% if section.tags %}
                <div class="flex flex-wrap mb-4">
                    {% for tag in section.tags %}
                    <span class="text-xs font-semibold mr-2 mb-1 px-2.5 py-1 rounded-full 
                        {% if '&' in tag %}
                            bg-orange-100 text-orange-800
                        {% elif tag.lower() == 'all' %}
                            bg-purple-200 text-purple-800
                        {% else %}
                            bg-blue-100 text-blue-800
                        {% endif %}">
                        {% if '&' in tag %}
                            <div class="flex flex-col text-center">
                                {% for component in tag.split('&') %}
                                    <span class="and-tag-component-inline">{{ component }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ tag }}
                        {% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="space-y-4 pl-4 border-l-2 border-gray-200">
                    {% for note in section.notes %}
                    <div class="bg-white p-4 rounded-md shadow-sm group/note">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-semibold text-gray-700">{{ note.noteTitle }}</h3>
                             <div class="flex items-center space-x-2 opacity-0 group-hover/note:opacity-100 transition-opacity">
                                <button onclick="showEditNoteModal('{{ section.id }}', '{{ note.id }}', '{{ note.noteTitle }}', `{{ note.content | e }}`, '{{ note.tags|join(', ') }}')" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200/70 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <form action="{{ url_for('delete_note', section_id=section.id, note_id=note.id, filter=request.args.getlist('filter'), state=current_state) }}" method="post" onsubmit="return confirm('Are you sure?');" class="inline">
                                    <button type="submit" class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-gray-200/70 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% if note.tags %}
                        <div class="flex flex-wrap my-2">
                            {% for tag in note.tags %}
                             <span class="text-xs font-semibold mr-2 mb-1 px-2.5 py-1 rounded-full 
                                {% if '&' in tag %}
                                    bg-orange-100 text-orange-800
                                {% elif tag.lower() == 'all' %}
                                    bg-purple-200 text-purple-800
                                {% else %}
                                    bg-blue-100 text-blue-800
                                {% endif %}">
                                {% if '&' in tag %}
                                    <div class="flex flex-col text-center">
                                        {% for component in tag.split('&') %}
                                            <span class="and-tag-component-inline">{{ component }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    {{ tag }}
                                {% endif %}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="prose prose-sm max-w-none mt-2 text-gray-600">
                            {{ note.content | safe }}
                        </div>
                    </div>
                    {% endfor %}
                    <form action="{{ url_for('add_note', section_id=section.id, filter=request.args.getlist('filter'), state=current_state) }}" method="post">
                        <button type="submit" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Add Note
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-8 pt-6 border-t flex items-center justify-end space-x-3">
             <form action="{{ url_for('add_section', filter=request.args.getlist('filter'), state=current_state) }}" method="post">
                 <button type="submit" class="flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all">
                    Add New Section
                </button>
             </form>
            <button onclick="showImportModal()" class="flex items-center justify-center px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-all">
                Manual Import Content
            </button>
            <button onclick="exportPdf()" class="flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-all">
                Save as PDF
            </button>
        </div>
    </div>
    
    <div id="editTitleModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('update_title', filter=request.args.getlist('filter'), state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Edit Document Title</h3>
                    <button type="button" onclick="hideModal('editTitleModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6">
                    <label for="documentTitle" class="block text-sm font-medium text-gray-700 mb-1">Document Title</label>
                    <input type="text" id="documentTitle" name="documentTitle" value="{{ document.documentTitle }}" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('editTitleModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="editSectionModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form id="editSectionForm" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-semibold">Edit Section</h3><button type="button" onclick="hideModal('editSectionModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button></div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="editSectionTitle" class="block text-sm font-medium text-gray-700 mb-1">Section Title</label>
                        <input type="text" id="editSectionTitle" name="sectionTitle" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                        <div class="relative">
                             <div id="editSectionTagsContainer" class="flex flex-wrap items-center w-full p-1 border border-gray-300 rounded-md bg-white min-h-[42px]">
                                 <input type="text" id="editSectionTagsInput" class="flex-grow p-1 outline-none text-sm" autocomplete="off" placeholder="Add a tag...">
                             </div>
                             <input type="hidden" id="editSectionTags" name="tags">
                             <div id="section-suggestions" class="tag-suggestions-dropdown hidden"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('editSectionModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editNoteModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl modal-container">
            <form id="editNoteForm" method="post" class="w-full flex flex-col h-full">
                 <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Edit Note</h3>
                    <div class="flex items-center gap-4">
                        <button type="button" onclick="cleanActiveEditorContent('note')" title="Clean empty lines" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.97c-2.43.4-4.88-.48-6.74-2.34-1.86-1.86-2.74-4.31-2.34-6.74"/><path d="M4.26 11.03c2.43-.4 4.88.48 6.74 2.34 1.86 1.86 2.74 4.31 2.34 6.74"/><path d="M12 2v20"/><path d="M2 12h20"/></svg>
                        </button>
                        <div id="editor-toggle-buttons" class="flex items-center rounded-md">
                             <button type="button" onclick="toggleEditorView('richtext')" class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-l-md">Rich Text</button>
                             <button type="button" onclick="toggleEditorView('html')" class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200">HTML</button>
                             <button type="button" onclick="toggleEditorView('preview')" class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-r-md">Preview</button>
                        </div>
                        <button type="button" onclick="hideModal('editNoteModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                </div>
                 <div class="p-6 space-y-4 modal-body">
                    <div><label for="editNoteTitle" class="block text-sm font-medium text-gray-700 mb-1">Note Title</label><input type="text" id="editNoteTitle" name="noteTitle" class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                        <div id="quill-editor-container">
                            <div id="quill-editor"></div>
                        </div>
                        <textarea id="html-editor" class="w-full p-2 border border-gray-300 rounded-md h-64 font-mono text-sm hidden"></textarea>
                        <div id="quill-preview-container" class="prose max-w-none p-2 border border-gray-300 rounded-md bg-gray-50 min-h-[240px] hidden"></div>
                        <textarea id="editNoteContent" name="content" class="hidden"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                        <div class="relative">
                            <div id="editNoteTagsContainer" class="flex flex-wrap items-center w-full p-1 border border-gray-300 rounded-md bg-white min-h-[42px]">
                                 <input type="text" id="editNoteTagsInput" class="flex-grow p-1 outline-none text-sm" autocomplete="off" placeholder="Add a tag...">
                             </div>
                             <input type="hidden" id="editNoteTags" name="tags">
                             <div id="note-suggestions" class="tag-suggestions-dropdown hidden"></div>
                        </div>
                    </div>
                 </div>
                 <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg border-t">
                    <button type="button" onclick="hideModal('editNoteModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
         </div>
    </div>
    
    <div id="renameTagModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('rename_global_tag', filter=request.args.getlist('filter'), state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-semibold">Rename Tag</h3><button type="button" onclick="hideModal('renameTagModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button></div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="renameOldTag" name="old_tag">
                    <div>
                        <label for="renameNewTag" class="block text-sm font-medium text-gray-700 mb-1">New name for <strong id="oldTagName"></strong></label>
                        <input type="text" id="renameNewTag" name="new_tag" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('renameTagModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <div id="createStateModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('create_state') }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Create New State</h3>
                    <button type="button" onclick="hideModal('createStateModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6">
                    <label for="new_state_name" class="block text-sm font-medium text-gray-700 mb-1">State Name</label>
                    <input type="text" id="new_state_name" name="state_name" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('createStateModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create State</button>
                </div>
            </form>
        </div>
    </div>

    <div id="renameStateModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('rename_state') }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-semibold">Rename State</h3><button type="button" onclick="hideModal('renameStateModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button></div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="renameOldStateName" name="old_state_name">
                    <div>
                        <label for="renameNewStateName" class="block text-sm font-medium text-gray-700 mb-1">New name for <strong id="oldStateName"></strong></label>
                        <input type="text" id="renameNewStateName" name="new_state_name" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('renameStateModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addCategoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('add_category', state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Create New Category</h3>
                    <button type="button" onclick="hideModal('addCategoryModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                </div>
                <div class="p-6">
                    <label for="new_category_name" class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                    <input type="text" id="new_category_name" name="category_name" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('addCategoryModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create Category</button>
                </div>
            </form>
        </div>
    </div>

    <div id="renameCategoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form action="{{ url_for('rename_category', state=current_state) }}" method="post" class="w-full">
                <div class="flex justify-between items-center p-4 border-b"><h3 class="text-xl font-semibold">Rename Category</h3><button type="button" onclick="hideModal('renameCategoryModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button></div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="renameOldCategoryId" name="category_id">
                    <div>
                        <label for="renameNewCategoryName" class="block text-sm font-medium text-gray-700 mb-1">New name for <strong id="oldCategoryName"></strong></label>
                        <input type="text" id="renameNewCategoryName" name="new_category_name" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" onclick="hideModal('renameCategoryModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Rename</button>
                </div>
            </form>
        </div>
    </div>


    <div id="importModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl modal-container">
            <form id="importForm" action="{{ url_for('import_html', filter=request.args.getlist('filter'), state=current_state) }}" method="post" class="w-full flex flex-col h-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold">Import Content</h3>
                     <div class="flex items-center gap-4">
                        <label for="docx-file-input" class="file-input-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                            Import .docx
                        </label>
                        <input type="file" id="docx-file-input" class="hidden" accept=".docx">
                        <button type="button" onclick="hideModal('importModal')" class="p-1 rounded-full hover:bg-gray-200">&times;</button>
                    </div>
                </div>
                <div class="p-6 modal-body">
                    <div class="flex items-center justify-between mb-2">
                        <div id="import-editor-toggle-buttons" class="flex items-center rounded-md">
                             <button type="button" onclick="toggleImportEditorView('richtext')" class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-l-md">Rich Text</button>
                             <button type="button" onclick="toggleImportEditorView('html')" class="toggle-btn px-3 py-1 text-sm font-semibold bg-gray-200 rounded-r-md">HTML</button>
                        </div>
                        <button type="button" onclick="cleanActiveEditorContent('import')" title="Clean empty lines" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-200 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.97c-2.43.4-4.88-.48-6.74-2.34-1.86-1.86-2.74-4.31-2.34-6.74"/><path d="M4.26 11.03c2.43-.4 4.88.48 6.74 2.34 1.86 1.86 2.74 4.31 2.34 6.74"/><path d="M12 2v20"/><path d="M2 12h20"/></svg>
                        </button>
                    </div>
                    <div id="import-editor-container">
                        <div id="import-editor"></div>
                    </div>
                    <textarea id="html-import-editor" class="w-full p-2 border border-gray-300 rounded-md font-mono text-sm hidden" placeholder="Paste your HTML here..."></textarea>
                    <input type="hidden" id="import_html_content" name="html_content">
                </div>
                <div class="p-4 bg-gray-50 flex justify-end items-center space-x-3 rounded-b-lg border-t">
                    <div class="flex items-center gap-4 mr-auto">
                        <span class="text-sm font-semibold text-gray-700">Import Mode:</span>
                        <label class="flex items-center text-sm"><input type="radio" name="import_mode" value="overwrite" class="form-radio" checked><span class="ml-2">Overwrite</span></label>
                        <label class="flex items-center text-sm"><input type="radio" name="import_mode" value="aggregate" class="form-radio"><span class="ml-2">Add to end</span></label>
                    </div>
                    <button type="button" onclick="hideModal('importModal')" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="submit-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Import</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // Expose global variables from Flask to the window object for your JS modules
    window.ALL_TAGS = JSON.parse('{{ all_tags | tojson | safe }}');
    window.CURRENT_STATE = '{{ current_state | safe }}';
    window.ACTIVE_FILTERS_LOWER = JSON.parse('{{ active_filters_lower | tojson | safe }}');
</script>
<script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>